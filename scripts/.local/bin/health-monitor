#!/bin/bash

# Battery
batteryPath="/sys/class/power_supply/BAT0"
batteryStatus=$(cat "$batteryPath/status")
# Fan
currentLevel=$(cat /proc/acpi/ibm/fan | grep "level:" | awk '{print $2}')
fanSpeed=$(sensors | grep 'fan1:' | tail -c 10 | tr -d ' ' | sed 's/RPM//')
# CPU
cpuTemp=$(sensors | grep 'CPU:' | tail -c 10 | tr -d ' ' | sed 's/°C//')
cpuFreqStats=$(awk -F ': ' '
    /cpu MHz/ {
        freq = int($2);
        sum += freq;
        count++;
        if (min == "" || freq < min) min = freq;
        if (max == "" || freq > max) max = freq;
    }
    END {
        if (count > 0) avg = sum/count;
        print min " " max " " int(avg);
    }
' /proc/cpuinfo)
read cpuFreqMin cpuFreqMax cpuFreqAvg <<< "$cpuFreqStats"

# Power consumption
consumption=$(expr $(cat "$batteryPath/power_now") / 100000)
units=$(expr $consumption / 10)
decimal=$(expr $consumption % 10)
consumption=$units.$decimal

if [ $# -gt 0 ]; then
    if [ $1 == '-h' ]; then
        cat /proc/acpi/ibm/fan
    elif [ $1 == 'watch' ]; then
        watch -n 0.5 -t $0
    elif [ $1 == 'executor' ]; then
        echo "$consumption W ($batteryStatus)         $cpuTemp°C ($fanSpeed RPM, $currentLevel)         $cpuFreqMin - $cpuFreqAvg - $cpuFreqMax MHz"
    else
        echo "$1" | sudo tee /proc/acpi/ibm/fan >/dev/null
    fi
    exit 0
fi

echo "Battery:        $consumption W ($batteryStatus)"
echo "Temperature:    $cpuTemp°C ($fanSpeed RPM, $currentLevel)"
echo "Frequency:      $cpuFreqMin - $cpuFreqAvg - $cpuFreqMax MHz"
